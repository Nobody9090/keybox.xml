name: Generate Encrypted Keybox XML
on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  generate-keybox:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y openssl libssl-dev
        pip install cryptography lxml

    - name: Generate keybox
      run: |
        git clone https://github.com/LRFP-Team/keyboxGenerator.git
        cd keyboxGenerator
        python3 keyboxGenerator.py || true
        ls -la keybox.xml

    - name: Validate Keybox XML Structure
      run: |
        cd keyboxGenerator
        # Check XML structure first
        if xmllint --noout keybox.xml 2>/dev/null; then
          echo "✅ Valid XML structure"
        else
          echo "❌ Invalid XML"
          exit 1
        fi
        # Extract and validate EC cert
        python3 -c "
import xml.etree.ElementTree as ET
tree = ET.parse('keybox.xml')
certs = tree.findall('.//Certificate[@format=\"pem\"]')
if certs:
    cert_pem = certs[0].text.strip()
    with open('extracted_cert.pem', 'w') as f:
        f.write(cert_pem)
    import subprocess
    result = subprocess.run(['openssl', 'x509', '-in', 'extracted_cert.pem', '-text', '-noout'], 
                           capture_output=True)
    if result.returncode == 0 and b'Keybox' in result.stdout:
        print('✅ Certificate valid')
    else:
        print('❌ Certificate validation failed')
        exit(1)
else:
    print('❌ No certificates found')
    exit(1)
"
        echo "✅ SHA256: $(sha256sum keybox.xml | cut -d' ' -f1)"
        echo "✅ Size: $(du -h keybox.xml)"

    - name: Encrypt ZIP
      env:
        ZIP_PASSWORD: ${{ secrets.KEYBOX_ZIP_PASSWORD }}
      run: |
        cd keyboxGenerator
        zip -P "$ZIP_PASSWORD" ../keybox-encrypted.zip keybox.xml
        cd ..
        echo "✅ ZIP SHA256: $(sha256sum keybox-encrypted.zip | cut -d' ' -f1)"
        echo "✅ ZIP Size: $(du -h keybox-encrypted.zip)"

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: keybox-encrypted
        path: |
          keybox-encrypted.zip
          keyboxGenerator/keybox.xml
        retention-days: 30
